<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta charset="UTF-8">
    <title>Dispense</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/make_tables.js"></script>
    <script>
        const vendingMachines = JSON.parse('{{ vendingMachines | tojson }}')
        const inventory = JSON.parse('{{ inventory | tojson }}')

    </script>
</head>

<body>
    {% include "headers/isLoggedinHeader.html" %}
    <div id="stores"></div>
    <hr/>
    <table border='1'>
        <tr>
            <th>Vending Machine</th>
            <th>Inventory</th>
        </tr>
        <tr>

            <td valign='top'>
                <div id="vendingMachine"></div> 
            </td>
            <td valign='top'>
                <div id="merchantInventory"></div>

            </td>


        </tr>
    <br />

    <script>
        function showVendingMachine(vendingMachineId) {
            console.log( "vendingMachineId: " + vendingMachineId)

            const headers = { "Content-Type": "application/json" }
                const body = JSON.stringify({"vendingId":vendingMachineId});
                const requestOptions = {
                    method: 'POST',
                    headers,
                    body,
                    redirect: 'follow'
                };
                fetch("/get_vending_machine", requestOptions)
                    .then(response => response.json())
                    .then(obj => {
                        const data = obj["data"][0]
                        let table = "<table border='1'><tr><th>vendingId</th><th>storeId</th><th>merchantId</th><th>version</th><th>averageMark</th></tr>"
                        table += "<tr>"
                        table += "<td>" + data[0] + "</td>"                                  
                        table += "<td>" + data[1] + "</td>"       
                        table += "<td>" + data[2] + "</td>"       
                        table += "<td>" + data[3] + "</td>"       
                        table += "<td>" + data[4] + "</td>"       
                        table += "</tr>"
                        table += "<tr><td colspan='5'>" + data[5] + "</td></tr>"
                        table += "</table>"

                        document.getElementById("vendingMachine").innerHTML = table; 
                    })
                    .catch(error => {
                        console.log("%c This was an error because: " + error.message, "background:lightred;")
                    })
        }

        try { 
            const data = JSON.parse('{{ stores | tojson }}')
            const stores = [] 
            data.forEach((datum)=> { 
                const obj = {
                    merchantId:datum[0],
                    storeId:datum[1],
                    storeName:datum[2],
                    storeAddress:datum[3],
                    merchantName:datum[4],
                    billing_address:datum[5],
                    phone:datum[6],
                    vending:"vending"
                }
                stores.push(obj)
            })
            let keys = Object.keys(stores[0])
            let table = "<table border='1' id='stores'><tr>"
            keys.forEach((key)=> { 
                table += "<th>" + key + "</th>"
            })
            table += "</tr>"

            stores.forEach((store)=> { 
                table += "<tr>"
                keys.forEach((key)=> { 
                    if ( key === "vending") {
                        // Create buttons for EACH vending machine in this store. 
                        // If a store has zero machines...   ...no buttons. 
                        // If a store has 20 machines...  20 buttons. 
                        // We might want to think of a machine naming convension.
                        let buttons = "" 
                        const storeId = store["storeId"]
                        vendingMachines[storeId].forEach((vendingId)=> { 
                            buttons += `<button onClick='showVendingMachine(${vendingId})'>${vendingId}</button>`
                        }) 
                        table += "<td>" + buttons + "</td>"
                    } else {
                        const value = store[key]
                        table += "<td>" + value + "</td>"
                    }
                })
                table += "</tr>"
            })
            table += "</table>"
            document.getElementById("stores").innerHTML = table
        } catch( error) { 
            console.log( error )
            alert( error)
        }



    </script>
    
    <script>
    makeInventoryTable(inventory, "merchantInventory")

    </script>
</body>

</html>