

<!DOCTYPE html>
<html>
  <head>
    <style>
      </style>
        <link rel="icon" href="data:;base64,iVBORw0KGgo=">
        <meta charset="UTF-8">
        <title>Dispense</title>
        <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    {% include "headers/isLoggedinHeader.html" %}
    merchant.html
    <div id="storesTable"></div>
    <hr/>
    <script>

        function getInventory( storeid_fk, merchantId_fk,machineId ) { 
            // alert( storeid_fk + "  " +  merchantId_fk + "    " + machineId )
            const obj = {
                storeid_fk, merchantId_fk,machineId
            }
            fetch('/get_inventory', { 
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(obj)
            }).then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                // console.log("%c " + JSON.stringify( data, null, 2),"background:tan"); 
                console.log("%c " + JSON.stringify( data, null, 2),"background:tan"); 
                // if ( data["status"] === "ok") {
                //   alert( "LINE 37 ")
                // } else { 
                //   alert( data["status"])
                // }
            }).catch(error => {
              console.error('There was a problem with the fetch operation!\n', error);
            });



        }

        function makeStoreAndVendingMachineTable(stores, vendingMachines) {
            function createVendingMachineTBody(storeId) { 
                let btns = [] 
                vendingMachines.forEach((vm)=> { 
                    if ( vm.storeid_fk === storeId ) {
                         const btn = `<button onClick='getInventory(${vm.storeid_fk}, ${vm.merchantId_fk}, "${vm.machineId}")'>merchantId=${vm.merchantId_fk}, storeId=${vm.storeid_fk}, id=${vm.machineId}</button>`                          
                         btns.push(btn)
                    }
                })
                return btns
            }

            let table = "<table border='1' class='storeTable'><tr>"
            let keys = Object.keys(stores[0])
            keys.forEach((column)=>{
                table += "<th>" + column + "</th>"
            })
            table += "</tr>"
            stores.forEach((store)=> { 
                table += "<tr>"
                keys.forEach((k)=> {
                    const v = store[k]
                    table += `<td>${v}</td>`
                })
                table += "</tr>"
                let btns = createVendingMachineTBody(store["storeId"])
                btns.forEach((btn)=> { 
                    table += "<tr><td colspan='2' style='background:white'>"  + btn + "</td></tr>"
                })
            })
            table += "</table>"
            document.getElementById("storesTable").innerHTML = table
        }

        const vendingMachines = JSON.parse('{{ vendingMachines | tojson }}')  
        const stores = JSON.parse('{{ stores | tojson }}')
        makeStoreAndVendingMachineTable(stores, vendingMachines)
    </script>
    <script src="/static/bag_of_functions.js"></script>
  </body>
</html>